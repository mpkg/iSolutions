<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Quick Address</title>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <link rel="stylesheet" href="http://jqueryui.com/resources/demos/style.css">
    <style>
        .ui-autocomplete-loading
        {
            background: white right center no-repeat;
        }
        #searchBox
        {
            width: 25em;
        }
    </style>
    <script type="text/javascript">
        var MIN_LENGTH = 4;
        var MAX_NUM = 3;
        var API_KEY = '40a64f101b6e6406c562814a37bdb84a';
        var API_URL = 'http://tel.search.ch/api/';
        var PAUSE = 1000;

        var XrmObject = window.parent.Xrm;

        $.support.cors = true; // Required - Enable cross domain requests;

        $(document).ready(function () {
            $("#searchBox").autocomplete({
                minLength: MIN_LENGTH,
                delay: PAUSE,
                source: function (request, response) {
                    var sourceData;
                    //Suggestions only after 4 letters in text field                    
                    $.ajax({
                        async: false,
                        url: API_URL,
                        data: {
                            key: API_KEY,
                            q: request.term,
                            maxnum: MAX_NUM // Limit suggestions to 3
                        },
                        success: function (data, textStatus, xmlHttpRequest) {
                            feed = data.getElementsByTagName('feed');
                            sourceData = $("entry", feed).map(function () {
                                return {
                                    label: getEntry('tel:name',this) + ', ' +
                                    getEntry('tel:street', this) + ', ' +
                                    getEntry('tel:streetno', this) + ', ' +
                                    getEntry('tel:city', this) + ', ' +
                                    getEntry('tel:zip', this),

                                    value: getEntry('tel:firstname',this) + ', ' +
                                    getEntry('tel:name', this) + ', ' +
                                    getEntry('tel:street', this) + ', ' +
                                    getEntry('tel:streetno', this) + ', ' +
                                    getEntry('tel:city', this) + ', ' +
                                    getEntry('tel:zip', this) + ', ' +
                                    getEntry('tel:canton', this) + ', ' +
                                    getEntry('tel:phone', this) + ', ' +
                                    getEntry('tel:extra', this) + ', ' +
                                    getEntry('tel:extra', this) + ', ' +
                                    getEntry('tel:extra', this)
                                };
                            }).get();
                            response(sourceData);
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            alert(errorThrown);
                        }
                    });
                },
                select: function (event, ui) {
                    var addressinfo = ui.item.valueOf.split(",");
                    setCRMFormFields(addressinfo);
                }
            });
        });

        function getEntry(fieldName, xml) {
            var node = xml.getElementsByTagName(fieldName);
            if (node != null) {                
                return node[0].textContent;

            }
            else {
                return '';
            }
        }

        function setCRMFormFields(addressInfo) {
            if (XrmObject.Page.getAttribute('name')) XrmObject.Page.getAttribute('name').setValue(addressInfo.name); //account name
            if (XrmObject.Page.getAttribute('address1_name')) XrmObject.Page.getAttribute('address1_name').setValue(addressInfo.name);
            if (XrmObject.Page.getAttribute('address1_line1')) XrmObject.Page.getAttribute('address1_line1').setValue(addressInfo.line1);
            if (XrmObject.Page.getAttribute('address1_line2')) XrmObject.Page.getAttribute('address1_line2').setValue(addressInfo.line2);
            if (XrmObject.Page.getAttribute('address1_line3')) XrmObject.Page.getAttribute('address1_line3').setValue(addressInfo.line3);
            if (XrmObject.Page.getAttribute('address1_city')) XrmObject.Page.getAttribute('address1_city').setValue(addressInfo.city);
            if (XrmObject.Page.getAttribute('address1_stateorprovince')) XrmObject.Page.getAttribute('address1_stateorprovince').setValue(addressInfo.state);
            if (XrmObject.Page.getAttribute('address1_country')) XrmObject.Page.getAttribute('address1_country').setValue(addressInfo.country);
            if (XrmObject.Page.getAttribute('address1_postalcode')) XrmObject.Page.getAttribute('address1_postalcode').setValue(addressInfo.postalcode);
            if (XrmObject.Page.getAttribute('address1_telephone1')) XrmObject.Page.getAttribute('address1_telephone1').setValue(addressInfo.phone);
            if (XrmObject.Page.getAttribute('websiteurl')) XrmObject.Page.getAttribute('websiteurl').setValue(addressInfo.website); //account website
        }
    </script>
</head>
<body>
    <div>
        <div class="ui-widget">
            <label for="searchBox">
                Search:
            </label>
            <input id="searchBox" />
        </div>
        <div id="searchResult" class="ui-widget" style="margin-top: 1em;">
        </div>
    </div>
</body>
</html>
